---
layout: post
title: 'DB에 CSV 데이터 올리기'
date: 2025-11-10 23:15 +0800
logs: [WishEasy]
toc: True
---
## WishEasy 개발 환경
프로젝트의 백엔드는 **Django 프레임워크**를 기반으로 구축되었으며, **개발(local)** 환경과 **운영(prod)** 환경을 구분해 관리하고 있다.

## 사용 기술 스택
- Backend Framework: Django
- Database
    - 개발 환경: SQLite (db.sqlite3)
    - 운영 환경: MySQL
- 배포 환경: AWS EC2 (Ubuntu)
- 환경 변수 관리: .env 파일을 통한 비공개 관리
- 버전 관리: Git + GitHub
- CI/CD: GitHub Actions (Ruff를 이용한 자동 린트 및 포맷 적용)
- 운영 서버 실행: Gunicorn + Nginx 조합

DB 같은 경우는, 로컬에서는 가벼운 `SQLite`로 개발 테스트를 진행하고, 운영 서버에서는 `MySQL`로 마이그레이션 후 EC2 환경에서 실행하도록 설정했다. 

## 전체 프로젝트 디렉토리 구조
```bash
project-wisheasy/
├── apps/                     # Django 앱 폴더
│   ├── accounts/             # 사용자 인증 관련 로직
│   ├── stations/             # 역 정보 및 노선 데이터 관리
│   ├── journeys/             # 경로 탐색 및 안내 로직
│   └── common/               # 공통 유틸, 상수 등
│
├── config/                   # 전역 설정
│   ├── settings/
│   │   ├── base.py           # 공통 설정
│   │   ├── local.py          # 개발용 설정 (SQLite)
│   │   └── prod.py           # 운영용 설정 (MySQL)
│   ├── urls.py
│   ├── wsgi.py
│   └── asgi.py
│
├── data_create/              # CSV/DB 초기 데이터 생성 스크립트
├── manage.py                 # Django 실행 엔트리포인트
├── .env                      # 환경 변수 (비공개)
├── .gitignore
└── requirements.txt          # Python 의존성 패키지 목록
```

- 테이블 구조는 journey/models.py 에 구조 설계를 해놨는데 데이터는 아직 CSV로만 가지고 있다.

## CSV 파일을 DB에 적재하기
**초기 데이터(CSV)** 를 직접 Django DB로 적재할 수 있도록 **ORM 기반**으로 구현했다

단순히 pandas로 DB에 넣는 대신, Django의 커스텀 명령어 체계를 이용하면
1. `models.py` 정의와 완전히 동일한 구조로 데이터를 저장할 수 있고
2. 테이블 관 관계를 ORM이 자동으로 검증해준다
3. 그리고 함수만 작성하면 자동으로 적재가 되는 유지보수도 쉽게 가능하다.

즉, `일관성` + `데이터 안정성` + `유지보수`의 이점이 있다.

### static/data/ ... 폴더에 csv 파일 저장
CSV 파일들은 `static/data/` 폴더 아래에 저장해놓으면 된다.

### app/journey/management/commands/load_csv.py
CSV를 DB에 업로드 할 수 있도록 `load_csv.py`를 작성해준다.
```python
import csv
import os
from typing import Optional

from django.core.management.base import BaseCommand, CommandError
from django.conf import settings

from apps.journeys.models import (
    Station,
    Line,
    Node,
    Edge,
    FastGate,
    Lines,
)

class Command(BaseCommand):
    def add_arguments(self, parser):
        ...
    
    def handle(self, *args, **options):
        ...
    
    def load_station(self, reader):
        ...

    def load_line(self, reader):
        ...

    def load_lines(self, reader):
        ...

    def load_nodes(self, reader):
        ...
    
    def load_edges(self, reader):
        ...

    def load_fastgate(self, reader):
        ...

    def load_stationline(self, reader):
        ...
```
| 함수명                      | 주요 역할                                                                                                                   |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------------- |
| **`add_arguments()`**    | 명령어 실행 시 `--file` 옵션을 받을 수 있도록 설정.<br>예: `python manage.py load_csv --file station.csv`                                 |
| **`handle()`**           | 명령 실행의 진입점. 입력받은 CSV 파일명을 기준으로 어떤 데이터 로더 함수를 호출할지 결정.<br>파일명에 따라 `load_station`, `load_line`, `load_edges` 등 분기 처리.     |
| **`load_station()`**     | `station.csv` 데이터를 읽어 **지하철역 정보(Station 모델)** 를 DB에 저장.<br>`update_or_create()`로 존재하면 수정, 없으면 신규 생성.                    |
| **`load_line()`**        | `line.csv` 데이터를 읽어 **노선(Line 모델)** 정보를 DB에 저장.<br>역과 달리 “호선 이름 및 ID” 중심으로 관리.                                           |
| **`load_lines()`**       | `lines.csv` 파일(노선별 역 순서 데이터)을 읽어 **노선 내 역 순서 정보(Lines 모델)** 를 등록.<br>한 노선(line)에 여러 역(station)이 순서(order_in_line)로 매핑됨. |
| **`load_nodes()`**       | `node.csv`를 읽어 **역 내의 세부 노드 정보(Node 모델)** 를 저장.<br>각 노드는 실제 승강장, 출구, 대합실 등 세부 위치 단위를 의미.                                |
| **`load_edges()`**       | `edge.csv`를 읽어 **노드 간 연결 관계(Edge 모델)** 를 생성.<br>`source_node`, `target_node`를 연결하며, 에스컬레이터 여부(`escalator`)도 함께 반영.      |
| **`load_fastgate()`**    | `FastGate.csv`를 읽어 **빠른 환승·출구 데이터(FastGate 모델)** 를 등록.<br>호선과 역 기준으로 에스컬레이터 위치, 탑승 게이트 등 정보를 매핑.                        |
| **`load_stationline()`** | `stationline.csv`를 읽어 **역과 노선의 다대다 관계(Station-Line 매핑)** 를 생성.<br>ManyToMany 중간 테이블(`Station.lines.through`)을 직접 채움.    |

### 로컬에 CSV파일 업로드
`models.py`를 기반으로 마이그레이션 후에 진행하는 것을 전제로 한다.

```python
python manage.py load_csv --file FastGate.csv --settings=config.settings.local
python manage.py load_csv --file edge.csv --settings=config.settings.local
python manage.py load_csv --file line.csv --settings=config.settings.local
python manage.py load_csv --file lines.csv --settings=config.settings.local
python manage.py load_csv --file node.csv --settings=config.settings.local
python manage.py load_csv --file station.csv --settings=config.settings.local
python manage.py load_csv --file stationline.csv --settings=config.settings.local
```

### Models.py에 정의된 제약 조건이 누락된다면..
![업로드]({{ '/assets/images/DB-CSV/csv업로드1.png' | relative_url }})
- 잘 들어간 결과는 이렇다

그런데 FastGate.csv를 업로드 하는데 노란색 오류가 발생하면서 DB에 데이터가 안올라갔다.

```bash
FastGate row 건너뜀 (station/line 누락): {'station_id': '233', 'line_id': '7', 'boarding_gate': '1-1', 'escalator': '1'} ⚠️ FastGate row 건너뜀 (station/line 누락): {'station_id': '233', 'line_id': '7', 'boarding_gate': '8-4', 'escalator': '0'} ⚠️ FastGate row 건너뜀 (station/line 누락): {'station_id': '233', 'line_id': '7', 'boarding_gate': '1-1', 'escalator': '0'}
```

**이유는 load_csv.py에서 FastGate의 id를 name으로 조회하도록 ORM 코드를 잘못적어서였다**

![수정]({{ '/assets/images/DB-CSV/데이터가안들어갔던이유수정.png' | relative_url }})
![결과]({{ '/assets/images/DB-CSV/fastgate잘들어감.png' | relative_url }})

해결!

